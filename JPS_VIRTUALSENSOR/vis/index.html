<!DOCTYPE html>
<html lan="eng">

<head>
	<!-- JS libraries -->
	<script src='https://api.mapbox.com/mapbox-gl-js/v2.0.0/mapbox-gl.js'></script>
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
	<script src='virtual-sensor.js'></script>
	<script src='agent-bridge.js'></script>
	<script src='constants.js'></script>
	
	<!-- Stylesheets -->
    <link href='https://api.mapbox.com/mapbox-gl-js/v2.0.0/mapbox-gl.css' rel='stylesheet' />
	<link href='style.css' rel='stylesheet' />  
	
	<!-- HELLO WORLD -->
	
</head>

<body>
    <div id="map"></div>
	
	<div id="resetContainer" onclick="resetCamera()">
		<div style="font-size:10pt; display:table-cell; vertical-align:middle;">
			<span>Reset View</span>
		</div>
	</div>
	
	<div id="side-panel" style="height:100%; width:400px; float:right;">
		<span id="closebtn" onclick="closePanel()">Hide</span>
		<div id="titleContainer"></div>
		<div id="subtitleContainer"></div>
		<div id="controlContainer">
			<p>Use the controls below to select a pollutant species and height. Once selected, a contour plot of the pollutant's coverage around the current sensor can be seen by selecting the "Show data" button.</p>
			<table width="90%" style="margin:auto;">
				<tr height="30px">
					<td width="25%" style="text-align:left;">Pollutant:</td>
					<td width="75%"><select class="select-css" id="pollutantBox"/></td>
				</tr>
				<tr height="30px">
					<td width="25%" style="text-align:left;">Height:</td>
					<td width="75%"><select class="select-css" id="heightBox"/></td>
				</tr>
				<tr height="30px">
					<td colspan="2" style="text-align: right;"><button onclick="showSensorData()">Show data</button></td>
				</tr>
			</table>
		</div>
		<div id="tableContainer"></div>
	</div>
	
    <script>	
		// MapBox API Token
		mapboxgl.accessToken = 'pk.eyJ1IjoiY21jbGlubm92YXRpb25zIiwiYSI6ImNrbGdqa3RoNDFnanIyem1nZXR3YzVhcmwifQ.hVk983r6YYlmFE8kSMbzhA';
       
	    // Load the map visualisation
        var map = new mapboxgl.Map({
            container: 'map',
            style: 'mapbox://styles/mapbox/light-v10',
            zoom: 10,
            center: [103.80977999427901, 1.3533492751332865]
        });
		
		// Disable double-click zoome
		map["doubleClickZoom"].disable();
					
		// On load...
        map.on('load', function () {
		
			// Sky layer that will show when the map is highly pitched
            map.addLayer({
                'id': 'sky',
                'type': 'sky',
                'paint': {
                    'sky-type': 'atmosphere'
                }
            });
			
			// 3D buildings data
			if (!map.getSource('composite')) {
				map.addSource('composite', {
					type: 'vector', 
					url: 'mapbox://styles/mapbox/streets-v11'}
				);
			} 
			
			// Insert the layer beneath any symbol layer.
			var layers = map.getStyle().layers;
			var labelLayerId;
			for (var i = 0; i < layers.length; i++) {
				if (layers[i].type === 'symbol' && layers[i].layout['text-field']) {
					labelLayerId = layers[i].id;
					break;
				}
			}
			
			// Layer style for 3D buildings
            map.addLayer({
					'id': '3d-buildings',
					'source': 'composite',
					'source-layer': 'building',
					'filter': ['==', 'extrude', 'true'],
					'type': 'fill-extrusion',
					'minzoom': 15,
					'paint': {
						'fill-extrusion-color': '#919191',
						'fill-extrusion-height': [
							'interpolate',
							['linear'],
							['zoom'],
							15,
							0,
							15.05,
							['get', 'height']
						],
						'fill-extrusion-base': [
							'interpolate',
							['linear'],
							['zoom'],
							15,
							0,
							15.05,
							['get', 'max_height']
						],
						'fill-extrusion-opacity': 0.75
					}
				},
				labelLayerId
			);
			
			// Close the side panel by default
			closePanel();
		
			// Initialise map event listeners
			initialiseListeners();
			
			// Load the existing sensors
			loadSensors(map);			
        });
    </script>
</body>

</html>